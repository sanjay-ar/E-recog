{"ast":null,"code":"import { __awaiter, __generator } from \"tslib\";\nimport { HttpRequest, HttpResponse } from \"@aws-sdk/protocol-http\";\nimport { isThrottlingError } from \"@aws-sdk/service-error-classification\";\nimport { v4 } from \"uuid\";\nimport { DEFAULT_MAX_ATTEMPTS, RETRY_MODES } from \"./config\";\nimport { DEFAULT_RETRY_DELAY_BASE, INITIAL_RETRY_TOKENS, INVOCATION_ID_HEADER, REQUEST_HEADER, THROTTLING_RETRY_DELAY_BASE } from \"./constants\";\nimport { getDefaultRetryQuota } from \"./defaultRetryQuota\";\nimport { defaultDelayDecider } from \"./delayDecider\";\nimport { defaultRetryDecider } from \"./retryDecider\";\n\nvar StandardRetryStrategy = function () {\n  function StandardRetryStrategy(maxAttemptsProvider, options) {\n    var _a, _b, _c;\n\n    this.maxAttemptsProvider = maxAttemptsProvider;\n    this.mode = RETRY_MODES.STANDARD;\n    this.retryDecider = (_a = options === null || options === void 0 ? void 0 : options.retryDecider) !== null && _a !== void 0 ? _a : defaultRetryDecider;\n    this.delayDecider = (_b = options === null || options === void 0 ? void 0 : options.delayDecider) !== null && _b !== void 0 ? _b : defaultDelayDecider;\n    this.retryQuota = (_c = options === null || options === void 0 ? void 0 : options.retryQuota) !== null && _c !== void 0 ? _c : getDefaultRetryQuota(INITIAL_RETRY_TOKENS);\n  }\n\n  StandardRetryStrategy.prototype.shouldRetry = function (error, attempts, maxAttempts) {\n    return attempts < maxAttempts && this.retryDecider(error) && this.retryQuota.hasRetryTokens(error);\n  };\n\n  StandardRetryStrategy.prototype.getMaxAttempts = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var maxAttempts, error_1;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            _a.trys.push([0, 2,, 3]);\n\n            return [4, this.maxAttemptsProvider()];\n\n          case 1:\n            maxAttempts = _a.sent();\n            return [3, 3];\n\n          case 2:\n            error_1 = _a.sent();\n            maxAttempts = DEFAULT_MAX_ATTEMPTS;\n            return [3, 3];\n\n          case 3:\n            return [2, maxAttempts];\n        }\n      });\n    });\n  };\n\n  StandardRetryStrategy.prototype.retry = function (next, args, options) {\n    return __awaiter(this, void 0, void 0, function () {\n      var retryTokenAmount, attempts, totalDelay, maxAttempts, request, _loop_1, this_1, state_1;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            attempts = 0;\n            totalDelay = 0;\n            return [4, this.getMaxAttempts()];\n\n          case 1:\n            maxAttempts = _a.sent();\n            request = args.request;\n\n            if (HttpRequest.isInstance(request)) {\n              request.headers[INVOCATION_ID_HEADER] = v4();\n            }\n\n            _loop_1 = function () {\n              var _b, response, output, e_1, err, delayFromDecider, delayFromResponse, delay_1;\n\n              return __generator(this, function (_c) {\n                switch (_c.label) {\n                  case 0:\n                    _c.trys.push([0, 4,, 7]);\n\n                    if (HttpRequest.isInstance(request)) {\n                      request.headers[REQUEST_HEADER] = \"attempt=\".concat(attempts + 1, \"; max=\").concat(maxAttempts);\n                    }\n\n                    if (!(options === null || options === void 0 ? void 0 : options.beforeRequest)) return [3, 2];\n                    return [4, options.beforeRequest()];\n\n                  case 1:\n                    _c.sent();\n\n                    _c.label = 2;\n\n                  case 2:\n                    return [4, next(args)];\n\n                  case 3:\n                    _b = _c.sent(), response = _b.response, output = _b.output;\n\n                    if (options === null || options === void 0 ? void 0 : options.afterRequest) {\n                      options.afterRequest(response);\n                    }\n\n                    this_1.retryQuota.releaseRetryTokens(retryTokenAmount);\n                    output.$metadata.attempts = attempts + 1;\n                    output.$metadata.totalRetryDelay = totalDelay;\n                    return [2, {\n                      value: {\n                        response: response,\n                        output: output\n                      }\n                    }];\n\n                  case 4:\n                    e_1 = _c.sent();\n                    err = asSdkError(e_1);\n                    attempts++;\n                    if (!this_1.shouldRetry(err, attempts, maxAttempts)) return [3, 6];\n                    retryTokenAmount = this_1.retryQuota.retrieveRetryTokens(err);\n                    delayFromDecider = this_1.delayDecider(isThrottlingError(err) ? THROTTLING_RETRY_DELAY_BASE : DEFAULT_RETRY_DELAY_BASE, attempts);\n                    delayFromResponse = getDelayFromRetryAfterHeader(err.$response);\n                    delay_1 = Math.max(delayFromResponse || 0, delayFromDecider);\n                    totalDelay += delay_1;\n                    return [4, new Promise(function (resolve) {\n                      return setTimeout(resolve, delay_1);\n                    })];\n\n                  case 5:\n                    _c.sent();\n\n                    return [2, \"continue\"];\n\n                  case 6:\n                    if (!err.$metadata) {\n                      err.$metadata = {};\n                    }\n\n                    err.$metadata.attempts = attempts;\n                    err.$metadata.totalRetryDelay = totalDelay;\n                    throw err;\n\n                  case 7:\n                    return [2];\n                }\n              });\n            };\n\n            this_1 = this;\n            _a.label = 2;\n\n          case 2:\n            if (!true) return [3, 4];\n            return [5, _loop_1()];\n\n          case 3:\n            state_1 = _a.sent();\n            if (typeof state_1 === \"object\") return [2, state_1.value];\n            return [3, 2];\n\n          case 4:\n            return [2];\n        }\n      });\n    });\n  };\n\n  return StandardRetryStrategy;\n}();\n\nexport { StandardRetryStrategy };\n\nvar getDelayFromRetryAfterHeader = function (response) {\n  if (!HttpResponse.isInstance(response)) return;\n  var retryAfterHeaderName = Object.keys(response.headers).find(function (key) {\n    return key.toLowerCase() === \"retry-after\";\n  });\n  if (!retryAfterHeaderName) return;\n  var retryAfter = response.headers[retryAfterHeaderName];\n  var retryAfterSeconds = Number(retryAfter);\n  if (!Number.isNaN(retryAfterSeconds)) return retryAfterSeconds * 1000;\n  var retryAfterDate = new Date(retryAfter);\n  return retryAfterDate.getTime() - Date.now();\n};\n\nvar asSdkError = function (error) {\n  if (error instanceof Error) return error;\n  if (error instanceof Object) return Object.assign(new Error(), error);\n  if (typeof error === \"string\") return new Error(error);\n  return new Error(\"AWS SDK error wrapper for \".concat(error));\n};","map":{"version":3,"sources":["/Users/sanjayar/Desktop/moody-main/node_modules/@aws-sdk/client-lex-runtime-v2/node_modules/@aws-sdk/middleware-retry/dist-es/StandardRetryStrategy.js"],"names":["__awaiter","__generator","HttpRequest","HttpResponse","isThrottlingError","v4","DEFAULT_MAX_ATTEMPTS","RETRY_MODES","DEFAULT_RETRY_DELAY_BASE","INITIAL_RETRY_TOKENS","INVOCATION_ID_HEADER","REQUEST_HEADER","THROTTLING_RETRY_DELAY_BASE","getDefaultRetryQuota","defaultDelayDecider","defaultRetryDecider","StandardRetryStrategy","maxAttemptsProvider","options","_a","_b","_c","mode","STANDARD","retryDecider","delayDecider","retryQuota","prototype","shouldRetry","error","attempts","maxAttempts","hasRetryTokens","getMaxAttempts","error_1","label","trys","push","sent","retry","next","args","retryTokenAmount","totalDelay","request","_loop_1","this_1","state_1","isInstance","headers","response","output","e_1","err","delayFromDecider","delayFromResponse","delay_1","concat","beforeRequest","afterRequest","releaseRetryTokens","$metadata","totalRetryDelay","value","asSdkError","retrieveRetryTokens","getDelayFromRetryAfterHeader","$response","Math","max","Promise","resolve","setTimeout","retryAfterHeaderName","Object","keys","find","key","toLowerCase","retryAfter","retryAfterSeconds","Number","isNaN","retryAfterDate","Date","getTime","now","Error","assign"],"mappings":"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","sourcesContent":["import { __awaiter, __generator } from \"tslib\";\nimport { HttpRequest, HttpResponse } from \"@aws-sdk/protocol-http\";\nimport { isThrottlingError } from \"@aws-sdk/service-error-classification\";\nimport { v4 } from \"uuid\";\nimport { DEFAULT_MAX_ATTEMPTS, RETRY_MODES } from \"./config\";\nimport { DEFAULT_RETRY_DELAY_BASE, INITIAL_RETRY_TOKENS, INVOCATION_ID_HEADER, REQUEST_HEADER, THROTTLING_RETRY_DELAY_BASE, } from \"./constants\";\nimport { getDefaultRetryQuota } from \"./defaultRetryQuota\";\nimport { defaultDelayDecider } from \"./delayDecider\";\nimport { defaultRetryDecider } from \"./retryDecider\";\nvar StandardRetryStrategy = (function () {\n    function StandardRetryStrategy(maxAttemptsProvider, options) {\n        var _a, _b, _c;\n        this.maxAttemptsProvider = maxAttemptsProvider;\n        this.mode = RETRY_MODES.STANDARD;\n        this.retryDecider = (_a = options === null || options === void 0 ? void 0 : options.retryDecider) !== null && _a !== void 0 ? _a : defaultRetryDecider;\n        this.delayDecider = (_b = options === null || options === void 0 ? void 0 : options.delayDecider) !== null && _b !== void 0 ? _b : defaultDelayDecider;\n        this.retryQuota = (_c = options === null || options === void 0 ? void 0 : options.retryQuota) !== null && _c !== void 0 ? _c : getDefaultRetryQuota(INITIAL_RETRY_TOKENS);\n    }\n    StandardRetryStrategy.prototype.shouldRetry = function (error, attempts, maxAttempts) {\n        return attempts < maxAttempts && this.retryDecider(error) && this.retryQuota.hasRetryTokens(error);\n    };\n    StandardRetryStrategy.prototype.getMaxAttempts = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var maxAttempts, error_1;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 2, , 3]);\n                        return [4, this.maxAttemptsProvider()];\n                    case 1:\n                        maxAttempts = _a.sent();\n                        return [3, 3];\n                    case 2:\n                        error_1 = _a.sent();\n                        maxAttempts = DEFAULT_MAX_ATTEMPTS;\n                        return [3, 3];\n                    case 3: return [2, maxAttempts];\n                }\n            });\n        });\n    };\n    StandardRetryStrategy.prototype.retry = function (next, args, options) {\n        return __awaiter(this, void 0, void 0, function () {\n            var retryTokenAmount, attempts, totalDelay, maxAttempts, request, _loop_1, this_1, state_1;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        attempts = 0;\n                        totalDelay = 0;\n                        return [4, this.getMaxAttempts()];\n                    case 1:\n                        maxAttempts = _a.sent();\n                        request = args.request;\n                        if (HttpRequest.isInstance(request)) {\n                            request.headers[INVOCATION_ID_HEADER] = v4();\n                        }\n                        _loop_1 = function () {\n                            var _b, response, output, e_1, err, delayFromDecider, delayFromResponse, delay_1;\n                            return __generator(this, function (_c) {\n                                switch (_c.label) {\n                                    case 0:\n                                        _c.trys.push([0, 4, , 7]);\n                                        if (HttpRequest.isInstance(request)) {\n                                            request.headers[REQUEST_HEADER] = \"attempt=\".concat(attempts + 1, \"; max=\").concat(maxAttempts);\n                                        }\n                                        if (!(options === null || options === void 0 ? void 0 : options.beforeRequest)) return [3, 2];\n                                        return [4, options.beforeRequest()];\n                                    case 1:\n                                        _c.sent();\n                                        _c.label = 2;\n                                    case 2: return [4, next(args)];\n                                    case 3:\n                                        _b = _c.sent(), response = _b.response, output = _b.output;\n                                        if (options === null || options === void 0 ? void 0 : options.afterRequest) {\n                                            options.afterRequest(response);\n                                        }\n                                        this_1.retryQuota.releaseRetryTokens(retryTokenAmount);\n                                        output.$metadata.attempts = attempts + 1;\n                                        output.$metadata.totalRetryDelay = totalDelay;\n                                        return [2, { value: { response: response, output: output } }];\n                                    case 4:\n                                        e_1 = _c.sent();\n                                        err = asSdkError(e_1);\n                                        attempts++;\n                                        if (!this_1.shouldRetry(err, attempts, maxAttempts)) return [3, 6];\n                                        retryTokenAmount = this_1.retryQuota.retrieveRetryTokens(err);\n                                        delayFromDecider = this_1.delayDecider(isThrottlingError(err) ? THROTTLING_RETRY_DELAY_BASE : DEFAULT_RETRY_DELAY_BASE, attempts);\n                                        delayFromResponse = getDelayFromRetryAfterHeader(err.$response);\n                                        delay_1 = Math.max(delayFromResponse || 0, delayFromDecider);\n                                        totalDelay += delay_1;\n                                        return [4, new Promise(function (resolve) { return setTimeout(resolve, delay_1); })];\n                                    case 5:\n                                        _c.sent();\n                                        return [2, \"continue\"];\n                                    case 6:\n                                        if (!err.$metadata) {\n                                            err.$metadata = {};\n                                        }\n                                        err.$metadata.attempts = attempts;\n                                        err.$metadata.totalRetryDelay = totalDelay;\n                                        throw err;\n                                    case 7: return [2];\n                                }\n                            });\n                        };\n                        this_1 = this;\n                        _a.label = 2;\n                    case 2:\n                        if (!true) return [3, 4];\n                        return [5, _loop_1()];\n                    case 3:\n                        state_1 = _a.sent();\n                        if (typeof state_1 === \"object\")\n                            return [2, state_1.value];\n                        return [3, 2];\n                    case 4: return [2];\n                }\n            });\n        });\n    };\n    return StandardRetryStrategy;\n}());\nexport { StandardRetryStrategy };\nvar getDelayFromRetryAfterHeader = function (response) {\n    if (!HttpResponse.isInstance(response))\n        return;\n    var retryAfterHeaderName = Object.keys(response.headers).find(function (key) { return key.toLowerCase() === \"retry-after\"; });\n    if (!retryAfterHeaderName)\n        return;\n    var retryAfter = response.headers[retryAfterHeaderName];\n    var retryAfterSeconds = Number(retryAfter);\n    if (!Number.isNaN(retryAfterSeconds))\n        return retryAfterSeconds * 1000;\n    var retryAfterDate = new Date(retryAfter);\n    return retryAfterDate.getTime() - Date.now();\n};\nvar asSdkError = function (error) {\n    if (error instanceof Error)\n        return error;\n    if (error instanceof Object)\n        return Object.assign(new Error(), error);\n    if (typeof error === \"string\")\n        return new Error(error);\n    return new Error(\"AWS SDK error wrapper for \".concat(error));\n};\n"]},"metadata":{},"sourceType":"module"}